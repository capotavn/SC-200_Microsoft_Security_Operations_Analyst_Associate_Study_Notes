# 9. Mitigate Threats Using Microsoft Purview

## I. Investigate and Respond to Microsoft Purview Data Loss Prevention Alerts

### Understanding DLP Alerts

**What is a DLP Alert?**
- Notifications triggered when actions match DLP policy conditions
- Can be single-event (e.g., emailing sensitive document to personal account) or aggregate (multiple small events accumulating over time)
- Alerts don't automatically indicate malicious activity—require investigation to determine if action is needed or policy needs tuning

**Where DLP Alerts Appear**
- **Microsoft Defender XDR**: For security investigations, consolidates incidents to connect multiple threat signals
- **Microsoft Purview**: For compliance focus on policy details, rules, and policy tuning

### DLP Alert Lifecycle

**1. Trigger**
- Alert starts when user action matches DLP policy condition
- Examples: Sharing sensitive data externally, downloading confidential files to removable media, uploading protected content to unsanctioned apps

**2. Notify**
- Alerts appear in Microsoft Defender portal and Microsoft Purview alerts dashboard
- Email notifications sent to admins/security teams based on policy setup
- Activity explorer provides detailed event information

**3. Triage**
- Review alerts to determine false positives or valid incidents
- Assign priority levels and designate response owners
- Defender portal groups related alerts into incidents for broader context
- Can use tags, comments, and filters to manage alert queue
- Filter by Service source: Data Loss Prevention to focus on DLP alerts
- Microsoft Security Copilot can analyze alert context and suggest next steps

**4. Investigate**
- Gather evidence and review activity logs
- **Investigation Tools**:
  - Microsoft Defender portal: View incidents, correlate alerts, tag users
  - Microsoft Purview alerts dashboard: Review alert context, update status
  - Activity explorer: Filter and view user actions
  - Content explorer: Deep review of triggering files/content
  - User activity summary: Up to 120 days of user behavior

**5. Remediate**
- Actions include: Mark as informational, follow up with user, block file sharing, revoke access, remove files, apply sensitivity labels, reset passwords, disable accounts, isolate devices
- Defender portal allows direct actions: Remove/quarantine files, revoke permissions, disable accounts, reset passwords, download/delete emails

**6. Tune**
- Adjust policy based on outcomes
- Consider: Sensitivity level of conditions, policy scope, notification settings, whether low-risk actions should trigger alerts
- Reduces false positives and improves detection over time

### Configuring DLP Policies to Generate Alerts

**Alert Types**
- **Single-event alerts**: Generated every time policy rule matches (for low-volume, high-sensitivity events)
- **Aggregate-event alerts**: Generated only when threshold met (e.g., 10 matches in 24 hours) to reduce alert fatigue

**Licensing Requirements**
- Single-event alerts: E1, F1, G1, E3, or G3 licenses
- Aggregate-event alerts: E5 license or add-ons (Office 365 ATP Plan 2, Microsoft 365 E5 Compliance, eDiscovery and Audit add-on)
- Aggregation window: 1-minute (E5/add-on) or 15-minute (E3/G3 without add-on)

**Required Roles**
- Compliance Administrator, Information Protection Admin, Security Operator, Security Reader, Information Protection Investigator
- Manage alerts role for DLP alert management dashboard

**Alert Behavior**
- Alerts trigger once per document even if shared/accessed multiple times
- Can take up to 3 hours for new/updated policy to generate alerts
- Endpoint DLP and Teams DLP alerts also appear in DLP alerts dashboard

### Investigating DLP Alerts in Microsoft Purview

**DLP Alerts Dashboard Features**
- Centralized view of recent alerts (30-day default retention)
- Supported workloads: Exchange, SharePoint, OneDrive, Teams, Devices, Instances, On-premises repositories, Fabric, Power BI

**Investigation Steps**

**Step 1: Filter and Find Alerts**
- Use Filters panel for policy name, severity, user, alert status, detection time
- Customize columns to show/hide properties

**Step 2: Review Alert Details**
- Details tab shows: Alert ID, status, severity, detection timestamp, matched policy/rule, workload

**Step 3: View Related User Activity**
- User activity summary tab (with Insider Risk Management integration) shows exfiltration activities up to 120 days

**Step 4: Review Matched Events**
- View detailed metadata: file name, location, size, timestamp
- Check if user received/overrode policy tip
- Actions available: Download content, apply/remove sensitivity label, unshare/delete file, send notification, copy event link

**Step 5: Complete Investigation**
- Add notes/comments, assign ownership, set status to Resolved

**Microsoft Security Copilot Integration**
- Provides AI-generated summaries: triggered policy/rule, file involved, user identity, Insider Risk level, suggested follow-up actions

**Share Alert Events**
- Create shareable links to specific events for collaboration
- Shared users see view-only information

**Limitations**
- Emails may be unavailable if deleted by sender or recipient

### Investigating DLP Alerts in Microsoft Defender XDR

**Why Use Defender XDR**
- Correlates related DLP alerts into incidents
- Extends investigation across endpoints, email, cloud apps, identities
- Enables response actions (disable accounts, revoke access)

**Investigation Process**

**Step 1: Open Incidents Queue**
- Navigate to Incidents & alerts > Incidents
- Filter by Service/detection source: Data Loss Prevention

**Step 2: Investigate Alert**
- Review Alert story, Related events, Sensitive info types
- Access Source tab to inspect involved file
- Microsoft Security Copilot provides summary (alert title, severity, policy/rule, file details, user identity)

**Step 3: Take Response Actions**
- Download email, apply sensitivity label, unshare/delete/download files, apply retention label, send notification
- User-level actions: Reset passwords, disable accounts
- Device-level actions: Isolate or manage device

**Step 4: Manage Incident**
- Set incident severity, add tags, assign to analyst, update status
- Choose classification: True Positive or False Positive with reason

**Advanced Hunting**
- Query CloudAppEvents table for deeper investigation
- Built-in queries: File shared with, File activities, Site activity, User DLP violations (last 30 days)
- Can run, customize, or save queries

**Microsoft Sentinel Integration**
- Cross-platform correlation and automation
- Use Microsoft Defender XDR connector to import DLP alerts
- Enable CloudAppEvents connector for audit logs
- Use KQL queries for correlation and root cause investigation

### Responding to DLP Alerts

**Response Actions in Microsoft Purview**
- Set alert status (Investigating, Resolved)
- Assign alert to reviewer
- Add comments for internal notes
- Share alert details via read-only link
- View user activity summary (with Insider Risk Management)

**Response Actions in Microsoft Defender XDR**
- Update incident status and assignments
- Apply classifications (True Positive, False Positive) with reasons
- Take remediation: Disable accounts, remove file access, apply labels
- Correlate with other security signals

## II. Investigate Insider Risk Alerts and Related Activity

### Understanding Insider Risk Alerts

**Alert Generation Process**
1. **Settings configured**: Configure risk indicators, sensitive domains, privacy preferences
2. **Policy created**: Define whose activity to evaluate, what to detect, triggering events
3. **Triggering event occurs**: Activates policy for specific user (e.g., resignation date set, risky website accessed, exfiltration behavior detected)
4. **User activity evaluated and scored**: Activities assigned risk scores based on type, thresholds, user history
5. **Alert generated**: When user's risk score exceeds policy-defined threshold

**Why Alert Generation Matters**
- Helps identify what triggered alert
- Understand which activities were evaluated
- Determine appropriate next steps
- Align alert evaluation with policy criteria

### Managing Alert Volume

**When Receiving Too Few Alerts**
- Enable more risk indicators in Policy indicators settings
- Include more users in policy scope
- Lower trigger thresholds for earlier evaluation
- Lower indicator thresholds for less severe activity
- Adjust alert volume slider toward "More alerts"

**When Receiving Too Many Alerts**
- Enable analytics to identify high-risk areas
- Use real-time insights to update thresholds
- Refine policy scope and content (narrow user list, prioritize sensitive files)
- Enable inline alert customization for analyst threshold adjustments
- Dismiss multiple low-priority alerts in bulk

**Configuration Options**
- Use appropriate policy templates for specific risk scenarios
- Configure global exclusions to prevent benign activity alerts
- Define detection groups for different user populations
- Create indicator variants to refine detection logic
- Adjust policy timeframes for activity evaluation scope
- Assign appropriate roles for configuration changes

### Investigating and Triaging Insider Risk Alerts

**Alert Dashboard Overview**
- Key fields: ID, Copilot icon, Users, Policy, Status, Spotlight, Alert severity (Low/Medium/High), Time detected, Assigned to, Case
- Can filter by risk factor, severity, policy, assigned analyst, triggering event
- Save custom filter views for commonly used alert queues
- Search by keyword (UPN, alert ID, assigned admin)

**Spotlight Feature**
- Automatically highlights high-priority alerts
- Uses rule-based logic to evaluate activity type, tags, risk scoring patterns
- Visually distinct in alert list for faster triage

**Reviewing Individual Alerts**
- **Alert summary**: Risk severity, alert score, triggering activity, triggering event
- **User details and history**: General info, past alerts, repeated risk patterns
- **Analysis tabs**: All risk factors, User activity, Activity explorer

**Triage Actions**
- Dismiss alert if triggered by expected/non-risky behavior
- Confirm and create case for deeper investigation
- Assign alert to another analyst/investigator
- Risk severity can increase if untriaged and more risky behavior occurs
- Can dismiss up to 400 alerts in bulk

**Security Copilot for Triage**
- Summarize alerts without opening them
- Summary includes: Policy name, triggering event, activity, key user attributes, top risk factors
- Suggests questions: "What actions did user perform in last 10 days?", "List sequential activities", "Any unusual behavior?"

**Retention and Limits**
- Alerts in "Needs review" state retained for 120 days
- Auto-deleted after period unless linked to active case
- Active/unresolved cases retained indefinitely
- Maximum 100 active cases per organization

### All Risk Factors Tab

**Risk Factors Shown**
- Top exfiltration activities (archiving, uploading files)
- Cumulative exfiltration (repeated actions building risk over time)
- Sequences of activities (related actions forming risk sequence)
- Priority content (interaction with sensitive/business-critical files)
- Unallowed domains (transfers to non-permitted domains)
- Unusual behavior or high-impact user status

**Content Detected Section**
- Shows specific items involved in risk activity
- View metadata: file name, type, location, sensitivity label
- Open Activity explorer for item's timeline context

**Important Behaviors**
- Risk factor summaries don't always match trigger
- Sequences can include excluded events if contributing to broader risky behavior
- Use Content detected section for deeper investigation via Activity explorer

### Activity Explorer Tab

**Features**
- Timeline of user activity contributing to alert
- Detailed metadata: Date/time, activity type, file name/location, sensitivity label, risk score, risk factors

**Activity Details**
- Select item to open details pane
- View: Event metadata, assigned risk score, contributing indicators

**Filter Options**
- **Activity scope**: All scored activity or alert-specific activity
- **Risk factor**: Sequences, cumulative exfiltration, unallowed domains, priority content
- **Review status**: Hide reviewed items to focus on new activity

**Customize View**
- Select/remove columns, sort by date/risk score, save custom views for reuse

**Activity Count Discrepancies**
- Cumulative exfiltration: Similar activities deduplicated and scored as single event
- Policy changes: Settings changes may exclude prior events
- Excluded items in sequences: Files excluded from scoring still appear if part of larger sequence

**Excluded Items in Sequences**
- Score of 0 for excluded event
- Marked as "Excluded" in activity details
- Link available to filter and view all excluded events

### User Activity Tab

**Visual Timeline**
- Colored bubbles show activity categories and risk scores over time
- Each bubble represents distinct risk event
- Select bubble for details: Date, risk category (Exfiltration/Obfuscation), risk score, number of files/emails

**Risk Sequences**
- Connecting lines between bubbles show related events
- Details include: Name, date range, combined risk score, total events, links to content

**Scatter Plot Features**
- Color-coded visualization of risky activity over time
- Vertical position indicates risk score
- Horizontal position shows event timing
- Identify clusters, gaps, sequences with connecting lines/icons

**Filter and Sort Options**
- Risk category (sequences, high-risk events)
- Activity type (AI usage, deletion)
- Date range (1, 3, or 6 months)
- Sort by risk score or event date
- Review status (filter reviewed activity)

**Full User Timeline**
- Events spanning multiple alerts
- Cumulative exfiltration risk as visual trend line
- Sequences including excluded file types if relevant to risk pattern
- Color-coded legend for risk event categories

### Investigating Insider Risk Alerts in Microsoft Defender XDR

**Integration Benefits**
- Combines Insider Risk Management alerts with other Microsoft security data
- Correlate with Defender for Endpoint, Microsoft Entra ID, Purview DLP
- Provides SOC analysts broader context for user behavior assessment

**Access Alerts in Defender XDR**
- Navigate to Investigation & response > Incidents & alerts > Incidents
- Filter by Service source: Microsoft Purview Insider Risk Management
- Alerts may be part of unified incident with multiple alert types

**Alert Status and Classification Sync**

| Microsoft Defender Status | Insider Risk Management Status |
|---------------------------|-------------------------------|
| New, In progress | Needs review |
| Resolved | Dismissed or Confirmed |

| Microsoft Defender Classification | Insider Risk Management Classification |
|-----------------------------------|---------------------------------------|
| True positive | Confirmed |
| Information, expected activity | Dismissed |
| False positive | Dismissed |

- Updates sync between portals within approximately 30 minutes

**Advanced Hunting**
- Use KQL to investigate insider risk activity
- Available tables: AlertInfo, AlertEvidence, DataSecurityBehaviors, DataSecurityEvents
- Requires Insider Risk Management Analyst or Investigator role

**Requirements and Setup**
- Enable "Share user risk details with other security solutions" in Purview portal
- Users need roles in both Purview (Insider Risk Management/Analyst/Investigator) and Defender (Security Operator/Reader)
- Licensing required for both solutions

**Limitations**
Data not available in Defender:
- Alerts from custom detections
- Risky AI usage events
- Non-Microsoft app events
- Exfiltration via email
- Events before alert generation
- Excluded events based on policy settings

### Managing Insider Risk Cases

**Case Purpose**
- Track user risk over time
- Review associated alerts
- Take action based on severity and context
- Focus on single user, can include multiple alerts
- Created manually when alert requires deeper review or team coordination

**Responding to Alerts**
- **Dismiss**: False positive or doesn't require review
- **Confirm**: Indicate policy violation, optionally create case
- Creating case recommended for: Serious risk, multiple incidents, needs cross-team collaboration

**Create and Manage Cases**
- Assign/reassign ownership
- Send email notice to user
- Escalate to Microsoft Purview eDiscovery (Premium)
- Run Power Automate flows
- Create/view connected Microsoft Teams team
- Resolve with classification: Benign or Confirmed policy violation
- Assignable to users with: Insider Risk Management, Analyst, or Investigator roles

**Cases Dashboard**
- Lists: Case name/ID, assigned user (anonymized if enabled), status (Active/Closed), number of alerts, time opened/last updated, last updated by
- Search by case ID or keywords
- Filter by status, date opened, last updated
- Customize columns and save filter views

**Investigate a Case**
- **Case overview**: User identity, department, risk score, associated alerts
- **Alerts**: Status, severity, alert ID
- **User activity**: Timeline of scored risk activity
- **Activity explorer** (preview): Detailed timeline and metadata
- **Forensic evidence**: Screen captures from triggering activity
- **Content explorer**: Copies of files and email messages
- **Case notes**: Permanent, timestamped analyst notes
- **Contributors**: Added users for collaboration (view only, can add notes)

**Case Actions**
- **Send email notice**: Reinforce policies/training using templates (recorded in Case notes)
- **Escalate for investigation**: Move to eDiscovery (Premium) for deeper investigation/legal hold
- **Run Power Automate flows**: Notify manager, create ServiceNow record, request HR details
- **Create/view Teams team**: Auto-created when case opened (archived when resolved)
- **Resolve case**: Mark as Benign or Confirmed policy violation with reason

## III. Search and Investigate with Microsoft Purview Audit

### Audit Overview

**Microsoft Purview Auditing Solutions**

| Capability | Audit (Standard) | Audit (Premium) |
|-----------|------------------|-----------------|
| Enabled by default | ✔ | ✔ |
| Search thousands of activities | ✔ | ✔ |
| Export search results to CSV | ✔ | ✔ |
| Search-UnifiedAuditLog PowerShell cmdlet | ✔ | ✔ |
| Office 365 Management Activity API access | ✔ | ✔ |
| Higher API bandwidth allocation | | ✔ |
| Default retention up to 180 days | ✔ | ✔ |
| Default 1-year retention (Microsoft Entra ID, Exchange, SharePoint, OneDrive) | | ✔ |
| Audit log retention policies (up to 10 years with add-on) | | ✔ |
| Intelligent insights (high-value events) | | ✔ |
| Audit Search Graph API | ✔ | ✔ |

**Audit (Standard)**
- Enabled by default, no manual setup required
- Thousands of searchable audit events across Microsoft 365 services
- Searchable in Microsoft Purview portal or via Search-UnifiedAuditLog cmdlet
- Export to CSV for deeper analysis
- Office 365 Management Activity API integration with SIEM systems
- 180-day default retention

**Audit (Premium)**
- All Audit (Standard) capabilities plus:
- Audit log retention policies (up to 1 year, or 10 years with add-on)
- Longer default retention (1 year for Microsoft Entra ID, Exchange, SharePoint, OneDrive; 180 days for other workloads)
- Intelligent insights (high-value events: labeled mail item access, user searches in Exchange Online/SharePoint Online)
- Higher API bandwidth (~2x compared to Standard)

**Audit Log Retention Policies**
- Scoped by service, activity type, or user
- Policies have priorities to control overlap
- Changing policy only affects future data

**Audit (Premium) Activities**
- Exchange Online: Mail item access, sensitivity label details
- Microsoft Teams: Chat interactions, meeting details, message modifications/deletions

**Copilot and AI Application Auditing**
- Interactions logged in unified audit log when auditing enabled
- Search by friendly name or operation (e.g., CopilotInteraction event)
- Schema includes context: thread IDs, accessed resources

### Configure and Manage Audit

**Step 1: Verify Subscription and Licensing**

**Audit (Standard)** included in:
- Microsoft 365: E3, E5, F1, F3
- Office 365: E1, E3, E5, F3

**Audit (Premium)** requires:
- Microsoft 365: E5, E5 Compliance, F5 Compliance, F5 Security + Compliance
- Office 365: E5

**Step 2: Assign Permissions**
- Roles: Audit Logs or View-Only Audit Logs
- Role groups: Audit Manager (search, export, manage settings), Audit Reader (search, export only)

**Step 3-5: Audit (Premium) Setup**

**Step 3: Set Up Audit (Premium) for Users**
- Verify user has E5 or appropriate add-on license
- Ensure Microsoft 365 Advanced Auditing is enabled in user's Apps settings
- Premium logging begins within 24 hours

**Step 4: Enable Audit (Premium) Events**
- Enable SearchQueryInitiatedExchange and SearchQueryInitiatedSharePoint with PowerShell:
```powershell
Set-Mailbox <user> -AuditOwner @{Add="SearchQueryInitiated"}
```
- In multi-geo tenants, run in region where user's mailbox is hosted

**Step 5: Set Up Audit Retention Policies**
- Create policies scoped by service, activity type, or user
- Durations up to 10 years with required add-on license

**Step 6: Search for Audited Events**
- Search audit log in Microsoft Purview portal

**Turn Auditing On or Off**
- Enabled by default, recording activities with 180-day retention
- Check status: `Get-AdminAuditLogConfig | Format-List UnifiedAuditLogIngestionEnabled`
- Enable: Select Audit in Purview portal banner (up to 60 minutes to start) or via PowerShell:
```powershell
Set-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $true
```
- Disable (PowerShell only):
```powershell
Set-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $false
```

### Conduct Searches with Audit (Standard)

**Prepare to Search**
- Verify auditing enabled: `Get-AdminAuditLogConfig | Format-List UnifiedAuditLogIngestionEnabled`
- Confirm permissions: Audit Logs or View-Only Audit Logs role
- Understand retention: E5 users have 1-year retention for Microsoft Entra ID, Exchange, SharePoint, OneDrive; others have 180 days
- PowerShell: Use Search-UnifiedAuditLog cmdlet for advanced searches
- API: Office 365 Management Activity API for programmatic integration

**Conduct Audit Search**
1. Sign in to Microsoft Purview portal
2. Select Solutions > Audit
3. Configure search parameters:
   - **Date range**: Default last 7 days, adjust to retention limit
   - **Keyword Search**: Keywords/phrases, use asterisk (*) for wildcards
   - **Admin Units**: Specific or all
   - **Activity types**: Friendly names or operation names
   - **Record types**: Service-specific filters
   - **Search name**: For future reference
   - **Users**: Individual accounts or all
   - **File, folder, or site**: Names or URLs (wildcards supported)
   - **Workloads**: Specific Microsoft services
4. Select Search (up to 10 concurrent searches per user)

**Manage Audit Search Jobs**
- Dashboard displays: Search name, job status (Queued/In Progress/Completed), progress %, search time, total results, creation time (UTC), performed by
- Delete search job to remove definition and results
- Copy search to duplicate with same parameters
- Completed jobs stored for 30 days, can reopen/re-export without rerunning

**View Search Results**
- Details: Date (UTC), IP Address, User, Record type, Activity, Item, Admin Units, Details
- Sort, filter, or export information
- Maximum 50,000 entries to CSV from single search

**Investigation Scenario Example: Unauthorized Access**
1. Define search criteria: Activities (Deleted messages from Deleted Items, Purged messages from mailbox), date range, users
2. Run search in Purview portal
3. Analyze results: Check deletion time, IP address, user details
4. For soft/hard-deleted items, view Details > More information for context
5. Take corrective action if unauthorized deletions confirmed
6. Recovery: SoftDeleted items recoverable within retention window (14-30 days), HardDeleted items may be recoverable if mailbox on hold

### Audit Microsoft Copilot Interactions

**Copilot Activities**
- **Friendly name**: Interacted with Copilot
- **Operation**: CopilotInteraction
- **Description**: User/admin/system entered prompts in Copilot

**Search for Copilot Activities**
1. Sign in to Microsoft Purview portal
2. Select Solutions > Audit
3. Set Start/End dates
4. Enter keywords in Keyword Search
5. Select Admin Units if applicable
6. Under Activities - friendly names, expand Copilot activities and select "Interacted with Copilot"
7. For Activities - operations names, type "CopilotInteraction"
8. In Record types, select Copilot-related record types
9. Name search
10. Specify users or leave blank
11. Enter file/folder/site names or leave blank
12. Select Search

**Scenario: Healthcare Data Security**
- IT compliance team ensures Copilot activities with patient data thoroughly logged
- Responsibilities: Compliance verification, identifying anomalies, audit management
- Technical actions: Configure audit settings, review logs regularly, update security measures based on analysis

### Investigate Activities with Audit (Premium)

**Audit (Premium) Overview**
- Extended data retention: Default 1 year for Microsoft Entra ID, Exchange, OneDrive, SharePoint; up to 10 years with add-on
- Customizable retention policies for specific services/activities/users
- Increased API bandwidth for data retrieval
- Intelligent insights: Detailed visibility into labeled mail access, user searches

**MailItemsAccessed Event**
- Critical for investigating sensitive communication access
- **Sync access**: Single event when multiple emails downloaded (e.g., Outlook)
- **Bind access**: Each individual email open/interaction logged

**Manage Audit Log Volume**
- Exchange Online throttles MailItemsAccessed if mailbox logs >1,000 bind events in 24 hours
- Throttling: Affects <1% of mailboxes, only MailItemsAccessed events, bind operations only, may cause gaps in bind event recording

**Investigation Scenario: Healthcare Access**
1. **Setup**: Identify mailboxes with sensitive data access, define time period
2. **Search**: Use Search-UnifiedAuditLog or Search-MailboxAuditLog:
```powershell
Search-UnifiedAuditLog -StartDate "2020-01-06" -EndDate "2020-01-20" -UserIds "user1, user2" -Operations MailItemsAccessed -ResultSize 1000
```
3. **Check throttling**:
```powershell
Search-UnifiedAuditLog -StartDate "2020-01-06" -EndDate "2020-01-20" -UserIds "user1, user2" -Operations MailItemsAccessed -ResultSize 1000 | Where {$_.AuditData -like '*"IsThrottled","Value":"True"*'} | FL
```
4. **Analyze sync/bind activities**:
   - Sync check: `Where {$_.AuditData -like '*"MailAccessType","Value":"Sync"*'}`
   - Bind check: `Where {$_.AuditData -like '*"MailAccessType","Value":"Bind"*'}`
5. **Contextual analysis**: Compare IP addresses, session IDs to separate regular vs. unauthorized access
6. **Forensic recovery**: Identify affected emails using InternetMessageId, record findings for compliance

**Manage Duplicate Audit Records**
- Filters duplicate records for same bind operations within 1 hour
- Sync operations filtered at 1-hour intervals unless distinct property changes
- Bind operations generate new record only if properties differ: ClientIPAddress, ClientInfoString, ParentFolder, Logon_type, MailAccessType, MailboxUPN/User, SessionId

**Contextual Analysis**
- Review IP addresses, session IDs, message identifiers
- Distinguish legitimate activity from potential breaches

### Export Audit Log Data

**Export Search Results**
1. Run audit search with desired filters
2. Select Export to download CSV (up to 50,000 entries)
3. Save file locally
4. If results exceed limit, narrow date range or apply more filters

**Transform Data with Power Query Editor**
1. Open blank Excel workbook > Data tab > From Text/CSV
2. Select Transform Data
3. Right-click AuditData > Transform > JSON
4. Select expand icon in AuditData column
5. Select Load more if needed
6. Deselect unneeded properties
7. Choose whether to include original column name as prefix
8. Select OK
9. Home tab > Close & Load

**Use PowerShell for Export**

Example - Export SharePoint sharing operations:
```powershell
$auditlog = Search-UnifiedAuditLog -StartDate 06/01/2019 -EndDate 06/30/2019 -RecordType SharePointSharingOperation
$auditlog | Select-Object CreationDate, UserIds, RecordType, AuditData | Export-Csv -Path C:\AuditLogs\SharePointAudit.csv -NoTypeInformation
```

Append more data:
```powershell
$auditlog = Search-UnifiedAuditLog -StartDate 06/01/2019 -EndDate 06/30/2019 -RecordType SharePointFileOperation
$auditlog | Select-Object CreationDate, UserIds, RecordType, AuditData | Export-Csv -Append -Path C:\AuditLogs\SharePointAudit.csv -NoTypeInformation
```

**Export Tips**
- Filter by RecordType for specific workloads
- Filter by Operations for key actions (sharing, deletion)
- Use Power Query transformations for readable JSON data

### Configure Audit Retention with Audit (Premium)

**Audit Log Retention Policy Overview**
- Define how long audit records kept (up to 10 years with appropriate licensing)
- Scoped by: All activities across services, specific activities within service for all/selected users, priority level

**Default Retention Policy**
- Retains records from Microsoft Entra ID, Exchange, OneDrive, SharePoint for 1 year
- Default can't be modified, but custom policies can be created

**Considerations**
- **Required role**: Organization Configuration role
- **Policy limit**: Up to 50 retention policies per organization
- **Licensing**: Retention >180 days requires Microsoft 365 E5, Office 365 E5, or equivalent add-on; 10-year retention requires add-on license
- **Policy priority**: Custom policies override default for covered records
- **Data retention timing**: Determined when record created; policy/license changes affect only new records

**Create Retention Policy**
1. Sign in to Microsoft Purview portal with Organization Configuration role
2. Go to Solutions > Audit > Audit retention policies
3. Select Create audit retention policy
4. Complete fields:
   - Policy name (unique)
   - Description (optional)
   - Users (all or specific)
   - Record type (single type; multiple types can't have activity-specific selections)
   - Duration (7 days to 10 years; >1 year requires specific licensing)
   - Priority (lower numbers = higher priority)
5. Select Save

**Manage Policies in Portal**
- View, edit, delete policies from Audit retention policies dashboard
- Adjust priority as needed

**Manage via PowerShell**

**Create policy**:
```powershell
New-UnifiedAuditLogRetentionPolicy -Name "Microsoft Teams Audit Policy" -Description "10-year retention policy for Teams activities" -RecordTypes MicrosoftTeams -RetentionDuration TenYears -Priority 100
```

**View policies**:
```powershell
Get-UnifiedAuditLogRetentionPolicy | Sort-Object -Property Priority -Descending | FL Priority,Name,Description,RecordTypes,Operations,UserIds,RetentionDuration
```

**Edit policy**:
```powershell
Set-UnifiedAuditLogRetentionPolicy -Identity "Microsoft Teams Audit Policy" -RetentionDuration FiveYears
```

**Delete policy** (up to 30 minutes for removal):
```powershell
Remove-UnifiedAuditLogRetentionPolicy -Identity "Microsoft Teams Audit Policy"
```

## IV. Search for Content with Microsoft Purview eDiscovery

### Understanding eDiscovery

**What is eDiscovery?**
- Feature in Microsoft Purview portal enabling authorized users to: Create cases, search for content, place holds to preserve data, export results
- Supports: Internal investigations, legal obligations, regulatory audits, incident response

**Licensing and Access**
- Users must be assigned eDiscovery Manager or eDiscovery Administrator role
- Core eDiscovery features included in Microsoft 365 E3 and E5 plans
- Advanced features may require separate licensing

**Common Scenarios**
- **Internal investigations**: Search messages, documents, files for HR or security incidents
- **Regulatory/legal requests**: Locate content for litigation, investigations, regulatory reviews
- **Data subject requests**: Identify and collect personal data for subject rights requests
- **Incident response**: Review user activity/communications after potential breach or misuse

### eDiscovery Prerequisites

**Required Roles**
- Global and Compliance Administrators can't access eDiscovery without explicit role assignment
- **eDiscovery Manager**: Create/manage cases, run content searches, export results
- **eDiscovery Administrator**: All Manager permissions plus manage role assignments and settings across all cases

**Assign Users to Roles**
1. In Microsoft Purview portal, select Settings > Roles and Scopes > Role groups
2. Search for appropriate eDiscovery role group
3. Add users or groups to role group
4. Users may need to sign out and back in to see eDiscovery interface

**Confirm Access**
1. Open Microsoft Purview portal
2. Select eDiscovery in left navigation
3. Cases page should load

### Create an eDiscovery Search

**Why Cases are Required**
- Every search must be associated with case
- Case provides: Controlled access to investigation data, auditable trail of actions, consistent structure for investigation tasks
- Case creator automatically added as member; other users must be added manually

**Create Search Directly**
1. Go to Microsoft Purview portal > Solutions > eDiscovery > Cases
2. Select arrow next to + Create case > Create search
3. Enter case name and search name
4. Optionally provide descriptions
5. Select Create

**Create Search Through Case**
1. Go to Solutions > eDiscovery > Cases
2. Select + Create case
3. Enter name and optional description
4. Select Create
5. On Searches tab, select Create search
6. Enter name and optional description
7. Select Create

### Conduct an eDiscovery Search

**Supported Microsoft 365 Workloads**
- Exchange Online: Email messages and calendar items
- SharePoint Online and OneDrive for Business: Files and document metadata
- Microsoft Teams: Chat messages (1:1 and group), channel messages, files shared
- Microsoft 365 Groups and Viva Engage: Group conversations and shared documents

**Search Phases**
1. Define scope
2. Identify data sources
3. Build query
4. Run and review results

**Phase 1: Define Search Criteria**
- Search name and optional description
- Data sources (users, groups, sites)
- Query using conditions, keywords, or KQL
- Use Conditions tab for filters (date range, sender)
- Use Keywords tab for text or KQL queries

**Phase 2: Identify Data Sources**
1. In Data sources section, select Add sources or Add tenant-wide sources
2. In Search for sources pane, filter by: All people and groups (default), People only, Groups only
3. Enter name, email address, or URL
4. Optionally select Exclude inactive users
5. Choose sources, select Save and close

**Phase 3: Build the Query**
- In Query tab, under Condition builder, select Add conditions
- Available options:
  - **KeyQL**: Advanced queries using Keyword Query Language
  - **Date**: Filter by sent, received, or modified dates
  - **Subject/Title**: Match terms in email subjects or document titles
  - **Participants**: Filter by sender, recipient, other participants
  - **Type**: Filter by message kind (Email, Chat, Teams)
- Each condition supports operators: equals, contains, starts with
- Conditions combined using AND

**Use Copilot to Generate Queries** (preview)
- Microsoft Security Copilot can build query from natural language prompt
- Example: "Find Teams messages sent by Alex Wilber between March 1 and March 15 that contain attachments related to budget planning"
- Generates suggested KeyQL query for review and editing

**Search by File** (preview)
- Use Search by file option for evidence like chat logs, documents, audit exports
- Upload sample data as search basis instead of manual queries
- Select Search by file (preview) tab
- Choose Attach files:
  - **Find similar content** (.txt file): Upload plain text sample to match
  - **Find reference content** (.csv file): Upload CSV (e.g., audit logs) to identify messages/files tied to specific users/actions
- File limit: 10 MB, .txt or .csv format
- KQL and condition builder disabled when using this method

**Phase 4: Run and Review Results**
1. Select Run query
2. Choose result type:
   - **Statistics**: Summary data (item count, result size, breakdown by location)
   - **Sample**: Random sample to validate query
3. Results appear in Query and Statistics tabs
4. Update conditions or data sources and rerun if results don't match expectations
5. Export content or add to review set when results confirmed

### Export eDiscovery Search Results

**Choose What to Export**
1. Go to Searches tab in case
2. Select completed search
3. Select Export
4. Provide export name
5. Choose item types:
   - Only indexed items matching query
   - Indexed items and partially indexed items
   - Only partially indexed items

**Configure Export Settings**

**OneDrive and SharePoint**
- Document versions to include: Latest, recent 10 or 100, all versions
- Include subfolder items that didn't match query
- Include attachments from SharePoint lists

**Mailboxes and Teams**
- Thread conversations into HTML transcripts (for chat review)
- Include contextual Teams and Viva Engage messages (up to 12 hours of related conversation)
- Include cloud attachments from SharePoint or OneDrive, choose version range

**Select Format and Structure**
- Export mailbox content as PST or MSG files
- Organize data by source location
- Include or condense original folder path
- Generate friendly names for easier reference

**Start Export and Track Progress**
1. Select Export to begin
2. Monitor from Process manager showing: Export status, completion time, item count, locations, options used

**Download Export Package**
1. Go to Exports tab in case
2. Select export to open Overview
3. In Export packages section, review downloadable files (message content, reports, metadata)
4. Select checkboxes next to desired files
5. Select Download
6. Download includes all exported content and summary reports

---

**End of Document**
